name: Release OpenList-magisk

on:
  push:
    tags:
      - "v*"

env:
  REPO_NAME: ${{ github.event.repository.name }}
  COMPILE_DATE: ${{ github.event.head_commit.timestamp }}

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        OpenWrt_ARCH: [arm64, x86_64]   # 可按需要增删
    steps:
      # 1. 拉源码
      - name: Checkout
        uses: actions/checkout@v4

      # 2. 打包（仅 OpenList-magisk 目录）
      - name: Zip OpenList-magisk
        run: |
          zip -r ${{ env.REPO_NAME }}-${{ matrix.OpenWrt_ARCH }}-release.zip \
                 OpenList-magisk/ -x "*.git*"

      # 3. 生成说明文件
      - name: Generate release note
        run: |
          touch ${{ env.REPO_NAME }}-${{ matrix.OpenWrt_ARCH }}-release.txt
          cat <<EOF > ${{ env.REPO_NAME }}-${{ matrix.OpenWrt_ARCH }}-release.txt
      🌐 管理地址: http://0.0.0.0:5244
      ⏱️ 编译时间: ${{ env.COMPILE_DATE }}
      👤 用户名: admin
      🔑 密码: KernelSU自行修改
      # 4. 创建 Release 并上传附件
      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}-${{ matrix.OpenWrt_ARCH }}
          body_path: ${{ env.REPO_NAME }}-${{ matrix.OpenWrt_ARCH }}-release.txt
          files: |
            ${{ env.REPO_NAME }}-${{ matrix.OpenWrt_ARCH }}-release.zip
            ${{ env.REPO_NAME }}-${{ matrix.OpenWrt_ARCH }}-release.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
